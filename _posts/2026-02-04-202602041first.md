---
layout: single
title:  "[2026-02-04] 20260204 개발일지"
categories: devlog
toc: true
---

## 통합 로그인 - AWS Cognito

### AWS Cognito란?
- AWS Cognito는 아마조너에서 제공하는 **로그인 서비스 대행**
- 직접 로그인 시스팀(아이디/비밀번호 저장, 비밀번호 찾기 등)을 구축하는 대신, 아마존이 미리 만들어둔 로그인 서비스를 가져다 쓰는 것
- 내 앱에 "구글로 로그인" 버튼을 다는 것과 비슷하지만, 내 앱만의 전용 로그인 시스템을 만드는 것이라고 보면 됨

### 동작 방식
1. 사용자가 앱에서 "로그인" 클릭
2. Cognito가 제공하는 로그인 페이지로 이동
3. 사용자가 정보 입력
4. Cognito가 정보를 확인하고 앱에 "토큰"을 발급
5. 사용자는 토큰을 가지고 앱으로 돌아옴
6. 앱은 이 토큰을 사용해 사용자가 로그인되었음을 확인

### 비교
1. Cognito가 없을 때 (직접 다 만들어야 함)
  - 작성해야 할 것: 회원가입, 비밀번호 암호화, 비밀번호 재설정 이메일, 이메일 인증, 토큰 생성, 토큰 검증, 유저 데이터베이스, 보안 업데이트 등
  - 결과: 1000줄 이상의 코드 + 지속적인 유지보수 필요
2. Cognito가 있을 때 (아마존이 대신 해줌):
  - 작성해야 할 것: Cognito가 준 토큰이 진짜인지 검증하는 로직
  - 결과: 약 50줄의 코드

### 코드 및 적용 예시
0. 사전 설정
    1. AWS 콘솔 → Cognito 이동
    2. "사용자 풀(User Pool) 생성" 클릭
    3. 설정 선택 (이메일 로그인, 비밀번호 규칙 등)
    4. 다음 값들을 기억 -> `User Pool ID: ap-northeast-2_ABC123, App Client ID: xyz789, Region: ap-northeast-2`
1. Frontend
    1. 패키지 설치 `npm install amazon-cognito-identity-js`
    2. 로그인 컴포넌트(Login.jsx)
    ```javascript
    import React, { useState } from 'react';
    import { CognitoUser, AuthenticationDetails, CognitoUserPool } from 'amazon-cognito-identity-js';
    
    const poolData = {
      UserPoolId: 'ap-northeast-2_ABC123',
      ClientId: 'xyz789'
    };
    const userPool = new CognitoUserPool(poolData);
    
    function Login() {
      const [username, setUsername] = useState('');
      const [password, setPassword] = useState('');
    
      const handleLogin = () => {
        const authenticationDetails = new AuthenticationDetails({
          Username: username, Password: password,
        });
        const cognitoUser = new CognitoUser({
          Username: username, Pool: userPool,
        });
    
        cognitoUser.authenticateUser(authenticationDetails, {
          onSuccess: (result) => {
            const token = result.getAccessToken().getJwtToken();
            localStorage.setItem('token', token); // 토큰 저장
            window.location.href = '/chat';       // 챗봇 페이지로 이동
          },
          onFailure: (err) => alert(err.message),
        });
      };
    
      return (
        <div style={{ padding: '50px' }}>
          <h2>로그인</h2>
          <input type="text" placeholder="아이디" onChange={(e) => setUsername(e.target.value)} />
          <input type="password" placeholder="비밀번호" onChange={(e) => setPassword(e.target.value)} />
          <button onClick={handleLogin}>로그인</button>
        </div>
      );
    }
    ```
2. Backend
    1. 패키지 설치 `pip install python-jose[cryptography] requests`
    2. 토큰 검증 (`main.py`)
    ```python
    from fastapi import FastAPI, HTTPException, Depends, Header
    from jose import jwt
    import requests
    
    app = FastAPI()
    
    REGION = 'ap-northeast-2'
    USER_POOL_ID = 'ap-northeast-2_ABC123'
    APP_CLIENT_ID = 'xyz789'
    JWKS_URL = f'https://cognito-idp.{REGION}.amazonaws.com/{USER_POOL_ID}/.well-known/jwks.json'
    
    def verify_token(authorization: str = Header(None)):
        if not authorization:
            raise HTTPException(status_code=401)
        
        token = authorization.split(' ')[1]
        keys = requests.get(JWKS_URL).json()
    
        try:
            # 토큰이 유효한지(만료되지 않았는지, 아마존이 서명한게 맞는지) 검사
            payload = jwt.decode(token, keys, algorithms=['RS256'], audience=APP_CLIENT_ID)
            return payload # 유효하면 유저 정보 반환
        except Exception:
            raise HTTPException(status_code=401, detail="유효하지 않은 토큰")
    
    @app.post("/api/chat")
    async def chat(request: dict, user: dict = Depends(verify_token)):
        # 로그인된 유저만 이 로직을 실행할 수 있습니다.
        return {"answer": f"{user['username']}님, 안녕하세요!", "user": user['username']}
    ```

### 이점
1. 비밀번호 저장
2. 비밀번호 재설정
3. 이메일 인증
4. 2단계 인증 MFA
5. 보안 업데이트
6. 관리자 페이지

### 정리
- Cognito는 아마존의 로그인 대행 서비스
- 프론트엔드는 사용자가 로그인하면 토큰을 받음
- 백엔드는 그 토큰을 확인해 진짜 유저인지 검증
